/* Combined Top 10*/

WITH cbTop10 AS
(
    SELECT a.*
    FROM (
    -- Build a query that returns product, location and order amount info 
    SELECT l.productId,
            p.displayName,
            ROUND(SUM(l.qty * l.price),2) amount,
            o.billing.country country,
            c.Country_Name
    FROM (
        -- combine/UNION results from Orders in US as well as Orders from Non US countries 
    SELECT VALUE NonUS
        FROM NonUSorders NonUS
    UNION ALL
        SELECT VALUE US
        FROM USorders US) o,
    o.lineItems l,
    products p,
    country c
    WHERE l.productId = p.productId
    AND o.billing.country = c.Two_Letter_Country_Code
    GROUP BY o.billing.country,
            l.productId,
            p.displayName,
            c.Country_Name
    ORDER BY amount DESC
    ) a
    -- apply window function to compute results by Countries and aggregate & sort by order amount
    WHERE rank() OVER (
    PARTITION BY country
    ORDER BY amount DESC) = 1
    ORDER BY amount DESC
    LIMIT 10
),

s3Top10 AS
(
    SELECT a.*
    FROM (
        SELECT  l.productId,
                p.displayName,
                ROUND(SUM(l.qty * l.price),2) prioramount,
                o.billing.country country,
                c.Country_Name
        FROM (
            SELECT VALUE s3
            FROM S3orders s3 
            ) o,
            o.lineItems l,
            products p,
            country c
    WHERE   l.productId = p.productId
    AND     o.billing.country = c.Two_Letter_Country_Code
    GROUP
    BY      o.billing.country,
            l.productId,
            p.displayName,
            c.Country_Name
    ORDER
    BY      prioramount DESC ) a
    WHERE rank() OVER (
    PARTITION BY country
    ORDER BY prioramount DESC) = 1
    ORDER BY prioramount DESC
    LIMIT 10
)
, 
combinedTop10 AS (SELECT cbTop10.* FROM cbTop10 UNION ALL SELECT s3Top10.* FROM s3Top10 )
SELECT displayName, Country_Name, SUM(amount) sum_amount, SUM(prioramount) sum_prioramount
FROM combinedTop10
GROUP BY displayName, Country_Name;
